<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Ãœye Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #eef2f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px 0; }
        .app-container { width: 100%; max-width: 900px; padding: 20px; }
        .card { border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 15px; }
        .hidden { display: none !important; }
        .welcome-header { background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; padding: 20px; border-radius: 15px 15px 0 0; }
        .table-responsive { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="app-container">

    <div id="authSection" class="row justify-content-center">
        <div class="col-md-5 mb-3">
            <div class="card p-4 h-100">
                <h3 class="text-center mb-3 text-primary">GiriÅŸ Yap</h3>
                <div class="mb-3">
                    <label>Ãœye ID</label>
                    <input type="number" id="loginId" class="form-control" placeholder="Ã–rn: 1001">
                </div>
                <div class="mb-3">
                    <label>Åifre</label>
                    <input type="password" id="loginPass" class="form-control" placeholder="******">
                </div>
                <button onclick="login()" class="btn btn-primary w-100 mt-auto">GiriÅŸ Yap</button>
            </div>
        </div>

        <div class="col-md-1 d-flex align-items-center justify-content-center mb-3">
            <span class="text-muted fw-bold">VEYA</span>
        </div>

        <div class="col-md-5 mb-3">
            <div class="card p-4 h-100">
                <h3 class="text-center mb-3 text-success">KayÄ±t Ol</h3>
                <div class="mb-2">
                    <label>Ad Soyad</label>
                    <input type="text" id="regName" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Åifre</label>
                    <input type="password" id="regPass" class="form-control">
                </div>
                <div class="mb-3">
                    <label>Ãœyelik Tipi</label>
                    <select id="regType" class="form-select">
                        <option value="Standard">Standard</option>
                        <option value="Student">Student (Ã–ÄŸrenci)</option>
                        <option value="Premium">Premium</option>
                    </select>
                </div>
                <button onclick="register()" class="btn btn-success w-100 mt-auto">KayÄ±t Ol ve ID Al</button>
            </div>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        
        <div class="card mb-4">
            <div class="welcome-header text-center">
                <h2 id="welcomeMsg">HoÅŸgeldin!</h2>
                <p id="userInfo" class="mb-0 opacity-75">ID: - | Ãœyelik: -</p>
            </div>
            
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-muted mb-3">Ders SeÃ§imi & Fiyat</h4>
                        <div class="mb-3">
                            <label>Ders Tipi</label>
                            <select id="resActivity" class="form-select" onchange="checkPrice()">
                                <option value="Yoga">Yoga</option>
                                <option value="Boxing">Boxing</option>
                                <option value="Fitness">Fitness</option>
                                <option value="Tennis">Tennis</option>
                                <option value="Swimming">Swimming</option>
                                <option value="Basketball">Basketball</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Saat (0-23)</label>
                            <input type="number" id="resHour" class="form-control" value="14" onchange="checkPrice()">
                        </div>
                        
                        <div class="alert alert-info text-center py-2">
                            <strong>Fiyat: </strong> <span id="priceDisplay" class="fs-5 fw-bold">-- TL</span>
                            <div id="discountMsg" class="small text-danger"></div>
                        </div>
                    </div>

                    <div class="col-md-6 d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            <label>Ders AdÄ± (SÄ±nÄ±f)</label>
                            <input type="text" id="resClassName" class="form-control" value="Yoga Flow A">
                        </div>
                        <button onclick="makeReservation()" class="btn btn-warning btn-lg w-100 mb-3">ğŸ“… Rezervasyonu Onayla</button>
                        <button onclick="logout()" class="btn btn-outline-danger w-100">Ã‡Ä±kÄ±ÅŸ Yap</button>
                    </div>
                </div>
                <div id="resResult" class="mt-3 text-center" style="display:none;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span class="fw-bold">ğŸŸï¸ Aktif RezervasyonlarÄ±m</span>
                <button onclick="loadReservations()" class="btn btn-sm btn-light text-dark">ğŸ”„ Listeyi Yenile</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Ders AdÄ±</th>
                                <th>Tip</th>
                                <th>Ã–denen</th>
                                <th class="text-end">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="myResTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
    const API_URL = "http://127.0.0.1:8000";
    
    // KullanÄ±cÄ± verisini tarayÄ±cÄ± hafÄ±zasÄ±nda tutuyoruz
    let currentUser = null; 

    // --- 1. KAYIT OL ---
    async function register() {
        const payload = {
            name: document.getElementById('regName').value,
            password: document.getElementById('regPass').value,
            membership_type: document.getElementById('regType').value
        };

        try {
            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(data.status === "success") {
                alert(`KayÄ±t BaÅŸarÄ±lÄ±! Sizin ID numaranÄ±z: ${data.member_id}\nLÃ¼tfen bu ID ile giriÅŸ yapÄ±n.`);
                document.getElementById('loginId').value = data.member_id;
            }
        } catch (err) {
            alert("KayÄ±t hatasÄ±!");
        }
    }

    // --- 2. GÄ°RÄ°Å YAP ---
    async function login() {
        const payload = {
            member_id: parseInt(document.getElementById('loginId').value),
            password: document.getElementById('loginPass').value
        };

        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if(!res.ok) throw new Error("GiriÅŸ BaÅŸarÄ±sÄ±z");
            
            const data = await res.json();
            currentUser = data;
            
            showDashboard();
        } catch (err) {
            alert("ID veya Åifre HatalÄ±!");
        }
    }

    // --- EKRAN GEÃ‡Ä°ÅÄ° ---
    function showDashboard() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        document.getElementById('welcomeMsg').innerText = `HoÅŸgeldin, ${currentUser.name}`;
        document.getElementById('userInfo').innerText = `ID: ${currentUser.member_id} | Ãœyelik: ${currentUser.membership_type}`;

        checkPrice();
        loadReservations(); // Listeyi hemen yÃ¼kle
    }

    function logout() {
        currentUser = null;
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('dashboardSection').classList.add('hidden');
        // Temizlik
        document.getElementById('resResult').style.display = 'none';
        document.getElementById('myResTableBody').innerHTML = '';
    }

    // --- 3. DÄ°NAMÄ°K FÄ°YAT ---
    async function checkPrice() {
        if (!currentUser) return;

        const activity = document.getElementById('resActivity').value;
        const hour = document.getElementById('resHour').value;
        const membership = currentUser.membership_type;

        try {
            const res = await fetch(`${API_URL}/price?activity=${activity}&hour=${hour}&membership=${membership}`);
            const data = await res.json();
            
            document.getElementById('priceDisplay').innerText = data.price + " TL";
            
            let info = "";
            if(membership === "Student") info = "(Ã–ÄŸrenci Ä°ndirimi)";
            if(membership === "Premium") info = "(Premium Tarifesi)";
            document.getElementById('discountMsg').innerText = info;
        } catch (err) { console.log("Fiyat hatasÄ±"); }
    }

    // --- 4. REZERVASYON YAP ---
    async function makeReservation() {
        if (!currentUser) return;

        const payload = {
            user_id: currentUser.member_id,
            class_name: document.getElementById('resClassName').value,
            class_type: document.getElementById('resActivity').value,
            hour: parseInt(document.getElementById('resHour').value)
        };

        try {
            const res = await fetch(`${API_URL}/reservations`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if(!res.ok) throw new Error(data.detail);

            const resultBox = document.getElementById('resResult');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <div class="alert alert-success">
                    âœ… Rezervasyon BaÅŸarÄ±lÄ±! <b>Ã–denecek:</b> ${data.price_to_pay} TL
                </div>
            `;
            
            // Listeyi gÃ¼ncelle ki yeni rezervasyon hemen gÃ¶rÃ¼nsÃ¼n
            loadReservations();
            
            // 3 saniye sonra baÅŸarÄ± mesajÄ±nÄ± gizle
            setTimeout(() => { resultBox.style.display = 'none'; }, 3000);

        } catch (err) {
            alert("Hata: " + err.message);
        }
    }

    // --- 5. REZERVASYONLARI LÄ°STELE (YENÄ°) ---
    async function loadReservations() {
        if (!currentUser) return;
        
        try {
            const res = await fetch(`${API_URL}/my_reservations/${currentUser.member_id}`);
            const data = await res.json();
            
            const tbody = document.getElementById('myResTableBody');
            tbody.innerHTML = ""; 
            
            if(data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' class='text-center py-3 text-muted'>HenÃ¼z aktif rezervasyonunuz yok.</td></tr>";
                return;
            }

            data.forEach(item => {
                const row = `
                    <tr>
                        <td class="align-middle fw-bold">#${item.id}</td>
                        <td class="align-middle">${item.class_name}</td>
                        <td class="align-middle"><span class="badge bg-info text-dark">${item.class_type}</span></td>
                        <td class="align-middle">${item.paid_price} TL</td>
                        <td class="text-end">
                            <button onclick="cancelReservation(${item.id})" class="btn btn-outline-danger btn-sm">âŒ Ä°ptal Et</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (err) {
            console.log("Liste yÃ¼klenemedi");
        }
    }

    // --- 6. Ä°PTAL ET VE SORU SOR (YENÄ°) ---
    async function cancelReservation(resId) {
        // KullanÄ±cÄ±ya soruyoruz
        let entrances = prompt("Bu rezervasyon kapsamÄ±nda kaÃ§ derse katÄ±lÄ±m saÄŸladÄ±nÄ±z?\n(0, 1, 2, 3... vb.)");
        
        // "Ä°ptal" derse veya boÅŸ bÄ±rakÄ±rsa iÅŸlem yapma
        if (entrances === null || entrances.trim() === "") return;

        const payload = {
            reservation_id: resId,
            entrances_used: parseInt(entrances)
        };

        try {
            const res = await fetch(`${API_URL}/cancel_reservation`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.status === "Cancelled") {
                alert(`âœ… Ä°ptal BaÅŸarÄ±lÄ±!\n\nğŸ’° Ä°ade Edilen Tutar: ${data.refund_amount} TL\nâ„¹ï¸ Bilgi: ${data.message}`);
                loadReservations(); // Listeyi gÃ¼ncelle
            } else {
                alert("Hata oluÅŸtu: " + data.detail);
            }
        } catch (err) {
            alert("BaÄŸlantÄ± hatasÄ±");
        }
    }
</script>

</body>
</html>