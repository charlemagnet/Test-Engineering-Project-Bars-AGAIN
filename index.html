<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym √úye Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #eef2f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px 0; }
        .app-container { width: 100%; max-width: 900px; padding: 20px; }
        .card { border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 15px; }
        .hidden { display: none !important; }
        .welcome-header { background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; padding: 20px; border-radius: 15px 15px 0 0; }
        .admin-header { background: linear-gradient(45deg, #dc3545, #fd7e14); color: white; padding: 20px; border-radius: 15px 15px 0 0; }
        .table-responsive { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="app-container">

    <div id="authSection" class="row justify-content-center">
        <div class="col-md-5 mb-3">
            <div class="card p-4 h-100">
                <h3 class="text-center mb-3 text-primary">Giri≈ü Yap</h3>
                <div class="mb-3">
                    <label>√úye ID</label>
                    <input type="number" id="loginId" class="form-control" placeholder="√ñrn: 1001">
                </div>
                <div class="mb-3">
                    <label>≈ûifre</label>
                    <input type="password" id="loginPass" class="form-control" placeholder="******">
                </div>
                <button onclick="login()" class="btn btn-primary w-100 mb-2">Giri≈ü Yap</button>
            </div>
        </div>

        <div class="col-md-1 d-flex align-items-center justify-content-center mb-3">
            <span class="text-muted fw-bold">VEYA</span>
        </div>

        <div class="col-md-5 mb-3">
            <div class="card p-4 h-100">
                <h3 class="text-center mb-3 text-success">Kayƒ±t Ol</h3>
                <div class="mb-2">
                    <label>Ad Soyad</label>
                    <input type="text" id="regName" class="form-control">
                </div>
                <div class="mb-2">
                    <label>≈ûifre</label>
                    <input type="password" id="regPass" class="form-control">
                </div>
                <div class="mb-3">
                    <label>√úyelik Tipi</label>
                    <select id="regType" class="form-select">
                        <option value="Standard">Standard</option>
                        <option value="Student">Student (√ñƒürenci)</option>
                        <option value="Premium">Premium</option>
                    </select>
                </div>
                <button onclick="register()" class="btn btn-success w-100 mt-auto">Kayƒ±t Ol ve ID Al</button>
            </div>
        </div>

        <div class="col-12 text-center mt-3">
            <button onclick="showAdminPanel()" class="btn btn-outline-dark btn-sm">üîí Admin Paneli (Veritabanƒ±)</button>
        </div>
    </div>

    <div id="dashboardSection" class="hidden">
        <div class="card mb-4">
            <div class="welcome-header text-center">
                <h2 id="welcomeMsg">Ho≈ügeldin!</h2>
                <p id="userInfo" class="mb-0 opacity-75">ID: - | √úyelik: -</p>
            </div>
            
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-muted mb-3">Ders Se√ßimi & Fiyat</h4>
                        <div class="mb-3">
                            <label>Ders Tipi</label>
                            <select id="resActivity" class="form-select" onchange="checkPrice()">
                                <option value="Yoga">Yoga</option>
                                <option value="Boxing">Boxing</option>
                                <option value="Fitness">Fitness</option>
                                <option value="Tennis">Tennis</option>
                                <option value="Swimming">Swimming</option>
                                <option value="Basketball">Basketball</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Saat (0-23)</label>
                            <input type="number" id="resHour" class="form-control" value="14" onchange="checkPrice()">
                        </div>
                        
                        <div class="alert alert-info text-center py-2">
                            <strong>Fiyat: </strong> <span id="priceDisplay" class="fs-5 fw-bold">-- TL</span>
                            <div id="discountMsg" class="small text-danger"></div>
                        </div>
                    </div>

                    <div class="col-md-6 d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            <label>Ders Adƒ± (Sƒ±nƒ±f)</label>
                            <input type="text" id="resClassName" class="form-control" value="Yoga Flow A">
                        </div>
                        <button onclick="makeReservation()" class="btn btn-warning btn-lg w-100 mb-3">üìÖ Rezervasyonu Onayla</button>
                        <button onclick="logout()" class="btn btn-outline-danger w-100">√áƒ±kƒ±≈ü Yap</button>
                    </div>
                </div>
                <div id="resResult" class="mt-3 text-center" style="display:none;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span class="fw-bold">üéüÔ∏è Aktif Rezervasyonlarƒ±m</span>
                <button onclick="loadReservations()" class="btn btn-sm btn-light text-dark">üîÑ Listeyi Yenile</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Ders Adƒ±</th>
                                <th>Tip</th>
                                <th>√ñdenen</th>
                                <th class="text-end">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="myResTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="adminSection" class="hidden">
        <div class="card">
            <div class="admin-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">üóÑÔ∏è Veritabanƒ± G√∂r√ºnt√ºleyici</h3>
                <button onclick="closeAdminPanel()" class="btn btn-light btn-sm">Kapat</button>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="text-muted">Kayƒ±tlƒ± √úyeler (Members Table)</h5>
                    <button onclick="loadAllUsers()" class="btn btn-primary btn-sm">üîÑ Tabloyu Yenile</button>
                </div>
                
                <div class="table-responsive border rounded">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>ƒ∞sim</th>
                                <th>√úyelik Tipi</th>
                                <th>≈ûifre (DB)</th> </tr>
                        </thead>
                        <tbody id="adminUserTable">
                            <tr><td colspan="4" class="text-center">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-warning mt-3 small">
                    <i class="bi bi-info-circle"></i> Not: ≈ûu an sadece <b>√úyeler</b> veritabanƒ±nda (SQLite) tutulmaktadƒ±r. Rezervasyonlar RAM √ºzerinde √ßalƒ±≈üƒ±r.
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const API_URL = "http://127.0.0.1:8000";
    let currentUser = null; 

    // --- AUTH ---
    async function register() {
        const payload = {
            name: document.getElementById('regName').value,
            password: document.getElementById('regPass').value,
            membership_type: document.getElementById('regType').value
        };
        try {
            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.status === "success") {
                alert(`Kayƒ±t Ba≈üarƒ±lƒ±! ID: ${data.member_id}`);
                document.getElementById('loginId').value = data.member_id;
            }
        } catch (err) { alert("Kayƒ±t hatasƒ±!"); }
    }

    async function login() {
        const payload = {
            member_id: parseInt(document.getElementById('loginId').value),
            password: document.getElementById('loginPass').value
        };
        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            currentUser = data;
            showDashboard();
        } catch (err) { alert("ID veya ≈ûifre Hatalƒ±!"); }
    }

    // --- DASHBOARD ---
    function showDashboard() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');

        document.getElementById('welcomeMsg').innerText = `Ho≈ügeldin, ${currentUser.name}`;
        document.getElementById('userInfo').innerText = `ID: ${currentUser.member_id} | √úyelik: ${currentUser.membership_type}`;
        checkPrice();
        loadReservations();
    }

    function logout() {
        currentUser = null;
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('dashboardSection').classList.add('hidden');
    }

    // --- ADMIN ---
    function showAdminPanel() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminSection').classList.remove('hidden');
        loadAllUsers();
    }

    function closeAdminPanel() {
        document.getElementById('adminSection').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
    }

    async function loadAllUsers() {
        try {
            const res = await fetch(`${API_URL}/admin/users`);
            const users = await res.json();
            
            const tbody = document.getElementById('adminUserTable');
            tbody.innerHTML = "";
            
            if(users.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center'>Kayƒ±tlƒ± √ºye yok.</td></tr>";
                return;
            }

            // Gelen veri formatƒ±: [{id: 1, name: "Ali", type: "Standard"}, ...] (API deƒüi≈üikliƒüine g√∂re)
            // Veya DatabaseManager'dan gelen ham liste olabilir. 
            // main.py'de `get_all_users_for_admin` dict d√∂nd√ºr√ºyor, ≈üifre olmayabilir.
            // Eƒüer database_manager direkt select * yapƒ±yorsa ≈üifre de gelir.
            
            users.forEach(user => {
                // Eƒüer ≈üifre API'den gelmiyorsa "-" yazalƒ±m
                const pass = user.password ? user.password : "(Gizli/Yok)"; 
                
                // NOT: user_manager.py i√ßindeki get_all_users_for_admin fonksiyonunda
                // password'√º de return ederseniz burada g√∂r√ºn√ºr.
                // ≈ûu anki haliyle id, name, type g√∂r√ºnecek.
                
                const row = `
                    <tr>
                        <td><b>${user.id}</b></td>
                        <td>${user.name}</td>
                        <td><span class="badge bg-secondary">${user.type || user.membership_type}</span></td>
                        <td class="text-muted font-monospace">****</td> 
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (err) {
            console.log("Admin verisi √ßekilemedi", err);
        }
    }

    // --- Dƒ∞NAMƒ∞K Fƒ∞YAT & REZERVASYON ---
    async function checkPrice() {
        if (!currentUser) return;
        const activity = document.getElementById('resActivity').value;
        const hour = document.getElementById('resHour').value;
        const membership = currentUser.membership_type;
        try {
            const res = await fetch(`${API_URL}/price?activity=${activity}&hour=${hour}&membership=${membership}`);
            const data = await res.json();
            document.getElementById('priceDisplay').innerText = data.price + " TL";
        } catch (err) {}
    }

    async function makeReservation() {
        if (!currentUser) return;
        const payload = {
            user_id: currentUser.member_id,
            class_name: document.getElementById('resClassName').value,
            class_type: document.getElementById('resActivity').value,
            hour: parseInt(document.getElementById('resHour').value)
        };
        try {
            const res = await fetch(`${API_URL}/reservations`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail);
            
            alert(`‚úÖ Rezervasyon Ba≈üarƒ±lƒ±! Tutar: ${data.price_to_pay} TL`);
            loadReservations();
        } catch (err) { alert(err.message); }
    }

    async function loadReservations() {
        if (!currentUser) return;
        try {
            const res = await fetch(`${API_URL}/my_reservations/${currentUser.member_id}`);
            const data = await res.json();
            const tbody = document.getElementById('myResTableBody');
            tbody.innerHTML = "";
            if(data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>Rezervasyon yok.</td></tr>";
                return;
            }
            data.forEach(item => {
                const row = `<tr><td>#${item.id}</td><td>${item.class_name}</td><td>${item.class_type}</td><td>${item.paid_price} TL</td><td class="text-end"><button onclick="cancelReservation(${item.id})" class="btn btn-danger btn-sm">ƒ∞ptal</button></td></tr>`;
                tbody.innerHTML += row;
            });
        } catch (err) {}
    }

    async function cancelReservation(resId) {
        let entrances = prompt("Ka√ß derse girdiniz? (0, 1, 2...)");
        if (entrances === null) return;
        const payload = { reservation_id: resId, entrances_used: parseInt(entrances) };
        try {
            const res = await fetch(`${API_URL}/cancel_reservation`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            alert(`ƒ∞ade: ${data.refund_amount} TL\n${data.message}`);
            loadReservations();
        } catch (err) { alert("Hata"); }
    }
</script>

</body>
</html>